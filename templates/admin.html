<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台 - 咖啡订购系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .report-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }
        
        .report-card h3 {
            color: #4a5568;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .stat-card h4 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .stat-card .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .date-filter {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .date-filter input {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        .export-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background: #38a169;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <header class="header">
            <h1>📊 管理后台</h1>
            <p>咖啡店经营数据分析与报告</p>
            <div style="margin-top: 15px;">
                <a href="/" class="btn btn-secondary">返回主页</a>
            </div>
        </header>

        <!-- 导航标签 -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">仪表盘</button>
            <button class="nav-tab" data-tab="sales">销售报告</button>
            <button class="nav-tab" data-tab="products">产品分析</button>
            <button class="nav-tab" data-tab="customers">客户分析</button>
            <button class="nav-tab" data-tab="orders">订单管理</button>
        </div>

        <!-- 内容区域 -->
        <div class="content">
            <!-- 仪表盘 -->
            <div id="dashboardTab" class="tab-content active">
                <h2 style="color: #4a5568; margin-bottom: 20px;">经营概况</h2>
                
                <div class="stat-grid" id="statsGrid">
                    <div class="stat-card">
                        <h4>今日销售额</h4>
                        <div class="stat-value" id="todaySales">¥0</div>
                        <small>与昨日对比</small>
                    </div>
                    <div class="stat-card">
                        <h4>今日订单数</h4>
                        <div class="stat-value" id="todayOrders">0</div>
                        <small>笔订单</small>
                    </div>
                    <div class="stat-card">
                        <h4>平均订单价值</h4>
                        <div class="stat-value" id="avgOrderValue">¥0</div>
                        <small>每笔订单</small>
                    </div>
                    <div class="stat-card">
                        <h4>总客户数</h4>
                        <div class="stat-value" id="totalCustomers">0</div>
                        <small>注册客户</small>
                    </div>
                </div>

                <div class="report-card">
                    <h3>📈 最近7天销售趋势</h3>
                    <div id="salesTrendChart" style="height: 300px; display: flex; align-items: center; justify-content: center; color: #718096;">
                        销售趋势图将在这里显示
                    </div>
                </div>
            </div>

            <!-- 销售报告 -->
            <div id="salesTab" class="tab-content">
                <h2 style="color: #4a5568; margin-bottom: 20px;">销售报告</h2>
                
                <div class="date-filter">
                    <label>开始日期:</label>
                    <input type="date" id="startDate">
                    <label>结束日期:</label>
                    <input type="date" id="endDate">
                    <button class="btn btn-primary" onclick="loadSalesReport()">查询</button>
                    <button class="export-btn" onclick="exportSalesReport()">导出报告</button>
                </div>

                <div class="report-card">
                    <h3>📊 销售数据</h3>
                    <div id="salesReportContainer">
                        <div style="text-align: center; padding: 40px;">
                            <div class="loading"></div>
                            <p style="margin-top: 10px; color: #718096;">正在加载销售报告...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 产品分析 -->
            <div id="productsTab" class="tab-content">
                <h2 style="color: #4a5568; margin-bottom: 20px;">产品销售分析</h2>
                
                <div class="report-card">
                    <h3>🏆 产品销售排行</h3>
                    <div id="productReportContainer">
                        <div style="text-align: center; padding: 40px;">
                            <div class="loading"></div>
                            <p style="margin-top: 10px; color: #718096;">正在加载产品分析...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 客户分析 -->
            <div id="customersTab" class="tab-content">
                <h2 style="color: #4a5568; margin-bottom: 20px;">客户分析</h2>
                
                <div class="report-card">
                    <h3>👥 客户消费排行</h3>
                    <div id="customerReportContainer">
                        <div style="text-align: center; padding: 40px;">
                            <div class="loading"></div>
                            <p style="margin-top: 10px; color: #718096;">正在加载客户分析...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 订单管理 -->
            <div id="ordersTab" class="tab-content">
                <h2 style="color: #4a5568; margin-bottom: 20px;">订单管理</h2>
                
                <div class="report-card">
                    <h3>📋 所有订单</h3>
                    <div id="allOrdersContainer">
                        <div style="text-align: center; padding: 40px;">
                            <div class="loading"></div>
                            <p style="margin-top: 10px; color: #718096;">正在加载订单...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // 管理后台特定的JavaScript代码
        let currentAdminTab = 'dashboard';

        document.addEventListener('DOMContentLoaded', function() {
            initializeAdmin();
        });

        function initializeAdmin() {
            setupAdminEventListeners();
            loadDashboard();
        }

        function setupAdminEventListeners() {
            // 导航标签点击事件
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const tabName = e.target.dataset.tab;
                    if (tabName) {
                        showAdminTab(tabName);
                    }
                });
            });

            // 设置默认日期
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
        }

        function showAdminTab(tabName) {
            // 更新导航标签
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // 更新内容区域
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`).classList.add('active');

            currentAdminTab = tabName;

            // 根据标签加载相应数据
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'sales':
                    loadSalesReport();
                    break;
                case 'products':
                    loadProductReport();
                    break;
                case 'customers':
                    loadCustomerReport();
                    break;
                case 'orders':
                    loadAllOrders();
                    break;
            }
        }

        async function loadDashboard() {
            try {
                // 加载统计数据
                const [salesResponse, ordersResponse, customersResponse] = await Promise.all([
                    fetch('/api/reports/sales'),
                    fetch('/api/orders'),
                    fetch('/api/reports/customers')
                ]);

                const salesData = await salesResponse.json();
                const ordersData = await ordersResponse.json();
                const customersData = await customersResponse.json();

                updateDashboardStats(salesData.data, ordersData.data, customersData.data);
            } catch (error) {
                console.error('加载仪表盘失败:', error);
                showAlert('加载仪表盘数据失败', 'error');
            }
        }

        function updateDashboardStats(salesData, ordersData, customersData) {
            // 计算今日数据
            const today = new Date().toISOString().split('T')[0];
            const todayData = salesData.find(item => item.date === today) || { total_sales: 0, order_count: 0, avg_order_value: 0 };

            document.getElementById('todaySales').textContent = `¥${todayData.total_sales.toFixed(2)}`;
            document.getElementById('todayOrders').textContent = todayData.order_count;
            document.getElementById('avgOrderValue').textContent = `¥${todayData.avg_order_value.toFixed(2)}`;
            document.getElementById('totalCustomers').textContent = customersData.length;
        }

        async function loadSalesReport() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                const response = await fetch(`/api/reports/sales?start_date=${startDate}&end_date=${endDate}`);
                const result = await response.json();

                if (result.success) {
                    renderSalesReport(result.data);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('加载销售报告失败:', error);
                showAlert('加载销售报告失败', 'error');
            }
        }

        function renderSalesReport(data) {
            const container = document.getElementById('salesReportContainer');
            
            if (data.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096;">选定时间范围内无销售数据</p>';
                return;
            }

            let totalSales = 0;
            let totalOrders = 0;

            const table = document.createElement('table');
            table.className = 'table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>订单数量</th>
                        <th>销售总额</th>
                        <th>平均订单价值</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map(item => {
                        totalSales += item.total_sales;
                        totalOrders += item.order_count;
                        return `
                            <tr>
                                <td>${item.date}</td>
                                <td>${item.order_count}</td>
                                <td>¥${item.total_sales.toFixed(2)}</td>
                                <td>¥${item.avg_order_value.toFixed(2)}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
                <tfoot>
                    <tr style="background: #f7fafc; font-weight: bold;">
                        <td>总计</td>
                        <td>${totalOrders}</td>
                        <td>¥${totalSales.toFixed(2)}</td>
                        <td>¥${totalOrders > 0 ? (totalSales / totalOrders).toFixed(2) : '0.00'}</td>
                    </tr>
                </tfoot>
            `;

            container.innerHTML = '';
            container.appendChild(table);
        }

        async function loadProductReport() {
            try {
                const response = await fetch('/api/reports/products');
                const result = await response.json();

                if (result.success) {
                    renderProductReport(result.data);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('加载产品报告失败:', error);
                showAlert('加载产品报告失败', 'error');
            }
        }

        function renderProductReport(data) {
            const container = document.getElementById('productReportContainer');
            
            if (data.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096;">暂无产品销售数据</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>产品名称</th>
                        <th>分类</th>
                        <th>销售数量</th>
                        <th>销售收入</th>
                        <th>订单次数</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map((item, index) => `
                        <tr>
                            <td>
                                <span style="color: #667eea; font-weight: bold;">#${index + 1}</span>
                                ${item.product_name}
                            </td>
                            <td>${item.category}</td>
                            <td>${item.total_quantity}</td>
                            <td>¥${item.total_revenue.toFixed(2)}</td>
                            <td>${item.order_count}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            container.innerHTML = '';
            container.appendChild(table);
        }

        async function loadCustomerReport() {
            try {
                const response = await fetch('/api/reports/customers');
                const result = await response.json();

                if (result.success) {
                    renderCustomerReport(result.data);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('加载客户报告失败:', error);
                showAlert('加载客户报告失败', 'error');
            }
        }

        function renderCustomerReport(data) {
            const container = document.getElementById('customerReportContainer');
            
            if (data.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096;">暂无客户数据</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>客户姓名</th>
                        <th>客户类型</th>
                        <th>订单数量</th>
                        <th>消费总额</th>
                        <th>平均订单价值</th>
                        <th>最后下单日期</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map((item, index) => `
                        <tr>
                            <td>
                                <span style="color: #667eea; font-weight: bold;">#${index + 1}</span>
                                ${item.customer_name}
                            </td>
                            <td>
                                <span class="badge ${item.customer_type === 'member' ? 'badge-gold' : 'badge-silver'}">
                                    ${item.customer_type === 'member' ? '会员' : '普通'}
                                </span>
                            </td>
                            <td>${item.order_count}</td>
                            <td>¥${item.total_spent.toFixed(2)}</td>
                            <td>¥${item.avg_order_value.toFixed(2)}</td>
                            <td>${item.last_order_date ? new Date(item.last_order_date).toLocaleDateString('zh-CN') : '无'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            container.innerHTML = '';
            container.appendChild(table);
        }

        async function loadAllOrders() {
            try {
                const response = await fetch('/api/orders');
                const result = await response.json();

                if (result.success) {
                    renderAllOrders(result.data);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('加载订单失败:', error);
                showAlert('加载订单失败', 'error');
            }
        }

        function renderAllOrders(orders) {
            const container = document.getElementById('allOrdersContainer');
            
            if (orders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096;">暂无订单数据</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>订单号</th>
                        <th>客户姓名</th>
                        <th>订单日期</th>
                        <th>状态</th>
                        <th>支付方式</th>
                        <th>总金额</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${orders.map(order => `
                        <tr>
                            <td>#${order.order_id}</td>
                            <td>${order.customer_name}</td>
                            <td>${new Date(order.order_date).toLocaleString('zh-CN')}</td>
                            <td><span class="status-${order.status}">${getStatusText(order.status)}</span></td>
                            <td>${getPaymentMethodText(order.payment_method)}</td>
                            <td>¥${order.total_amount.toFixed(2)}</td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8em;" 
                                        onclick="viewOrderDetails(${order.order_id})">
                                    查看详情
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            container.innerHTML = '';
            container.appendChild(table);
        }

        function exportSalesReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // 这里可以实现导出功能，比如生成CSV文件
            showAlert('导出功能开发中...', 'info');
        }
    </script>

    <style>
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .badge-gold {
            background: linear-gradient(45deg, #f6ad55, #ed8936);
            color: white;
        }
        
        .badge-silver {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .status-pending { color: #ed8936; }
        .status-processing { color: #3182ce; }
        .status-completed { color: #38a169; }
        .status-cancelled { color: #e53e3e; }
    </style>
</body>
</html>