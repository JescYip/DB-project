<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå° - å’–å•¡è®¢è´­ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .report-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }
        
        .report-card h3 {
            color: #4a5568;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .stat-card h4 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .stat-card .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .date-filter {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .date-filter input {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        .export-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background: #38a169;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <h1>ğŸ“Š ç®¡ç†åå°</h1>
            <p>å’–å•¡åº—ç»è¥æ•°æ®åˆ†æä¸æŠ¥å‘Š</p>
            <div style="margin-top: 15px;">
                <a href="/" class="btn btn-secondary">è¿”å›ä¸»é¡µ</a>
            </div>
        </header>

        <!-- å¯¼èˆªæ ‡ç­¾ -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">ä»ªè¡¨ç›˜</button>
            <button class="nav-tab" data-tab="sales">é”€å”®æŠ¥å‘Š</button>
            <button class="nav-tab" data-tab="products">äº§å“åˆ†æ</button>
            <button class="nav-tab" data-tab="customers">å®¢æˆ·åˆ†æ</button>
            <button class="nav-tab" data-tab="orders">è®¢å•ç®¡ç†</button>
        </div>

        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="content">
            <!-- ä»ªè¡¨ç›˜ -->
            <div id="dashboardTab" class="tab-content active">
                <h2 style="color: #4a5568; margin-bottom: 20px;">ç»è¥æ¦‚å†µ</h2>
                
                <div class="stat-grid" id="statsGrid">
                    <div class="stat-card">
                        <h4>ä»Šæ—¥é”€å”®é¢</h4>
                        <div class="stat-value" id="todaySales">Â¥0</div>
                        <small>ä¸æ˜¨æ—¥å¯¹æ¯”</small>
                    </div>
                    <div class="stat-card">
                        <h4>ä»Šæ—¥è®¢å•æ•°</h4>
                        <div class="stat-value" id="todayOrders">0</div>
                        <small>ç¬”è®¢å•</small>
                    </div>
                    <div class="stat-card">
                        <h4>å¹³å‡è®¢å•ä»·å€¼</h4>
                        <div class="stat-value" id="avgOrderValue">Â¥0</div>
                        <small>æ¯ç¬”è®¢å•</small>
                    </div>
                    <div class="stat-card">
                        <h4>æ€»å®¢æˆ·æ•°</h4>
                        <div class="stat-value" id="totalCustomers">0</div>
                        <small>æ³¨å†Œå®¢æˆ·</small>
                    </div>
                </div>

                <div class="report-card">
                    <h3>ğŸ“ˆ æœ€è¿‘7å¤©é”€å”®è¶‹åŠ¿</h3>
                    <div id="salesTrendChart" style="height: 300px; display: flex; align-items: center; justify-content: center; color: #718096;">
                        é”€å”®è¶‹åŠ¿å›¾å°†åœ¨è¿™é‡Œæ˜¾ç¤º
                    </div>
                </div>
            </div>

            <!-- é”€å”®æŠ¥å‘Š -->
            <div id="salesTab" class="tab-content">
                <h2 style="color: #4a5568; margin-bottom: 20px;">é”€å”®æŠ¥å‘Š</h2>
                
                <div class="date-filter">
                    <label>å¼€å§‹æ—¥æœŸ:</label>
                    <input type="date" id="startDate">
                    <label>ç»“æŸæ—¥æœŸ:</label>
                    <input type="date" id="endDate">
                    <button class="btn btn-primary" onclick="loadSalesReport()">æŸ¥è¯¢</button>
                    <button class="export-btn" onclick="exportSalesReport()">å¯¼å‡ºæŠ¥å‘Š</button>
                </div>

                <div class="report-card">
                    <h3>ğŸ“Š é”€å”®æ•°æ®</h3>
                    <div id="salesReportContainer">
                        <div style="text-align: center; padding: 40px;">
                            <div class="loading"></div>
                            <p style="margin-top: 10px; color: #718096;">æ­£åœ¨åŠ è½½é”€å”®æŠ¥å‘Š...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- äº§å“åˆ†æ -->
            <div id="productsTab" class="tab-content">
                <h2 style="color: #4a5568; margin-bottom: 20px;">äº§å“é”€å”®åˆ†æ</h2>
                
                <div class="report-card">
                    <h3>ğŸ† äº§å“é”€å”®æ’è¡Œ</h3>
                    <div id="productReportContainer">
                        <div style="text-align: center; padding: 40px;">
                            <div class="loading"></div>
                            <p style="margin-top: 10px; color: #718096;">æ­£åœ¨åŠ è½½äº§å“åˆ†æ...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å®¢æˆ·åˆ†æ -->
            <div id="customersTab" class="tab-content">
                <h2 style="color: #4a5568; margin-bottom: 20px;">å®¢æˆ·åˆ†æ</h2>
                
                <div class="report-card">
                    <h3>ğŸ‘¥ å®¢æˆ·æ¶ˆè´¹æ’è¡Œ</h3>
                    <div id="customerReportContainer">
                        <div style="text-align: center; padding: 40px;">
                            <div class="loading"></div>
                            <p style="margin-top: 10px; color: #718096;">æ­£åœ¨åŠ è½½å®¢æˆ·åˆ†æ...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è®¢å•ç®¡ç† -->
            <div id="ordersTab" class="tab-content">
                <h2 style="color: #4a5568; margin-bottom: 20px;">è®¢å•ç®¡ç†</h2>
                
                <div class="report-card">
                    <h3>ğŸ“‹ æ‰€æœ‰è®¢å•</h3>
                    <div id="allOrdersContainer">
                        <div style="text-align: center; padding: 40px;">
                            <div class="loading"></div>
                            <p style="margin-top: 10px; color: #718096;">æ­£åœ¨åŠ è½½è®¢å•...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // ç®¡ç†åå°ç‰¹å®šçš„JavaScriptä»£ç 
        let currentAdminTab = 'dashboard';

        document.addEventListener('DOMContentLoaded', function() {
            initializeAdmin();
        });

        function initializeAdmin() {
            setupAdminEventListeners();
            loadDashboard();
        }

        function setupAdminEventListeners() {
            // å¯¼èˆªæ ‡ç­¾ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const tabName = e.target.dataset.tab;
                    if (tabName) {
                        showAdminTab(tabName);
                    }
                });
            });

            // è®¾ç½®é»˜è®¤æ—¥æœŸ
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
        }

        function showAdminTab(tabName) {
            // æ›´æ–°å¯¼èˆªæ ‡ç­¾
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // æ›´æ–°å†…å®¹åŒºåŸŸ
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`).classList.add('active');

            currentAdminTab = tabName;

            // æ ¹æ®æ ‡ç­¾åŠ è½½ç›¸åº”æ•°æ®
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'sales':
                    loadSalesReport();
                    break;
                case 'products':
                    loadProductReport();
                    break;
                case 'customers':
                    loadCustomerReport();
                    break;
                case 'orders':
                    loadAllOrders();
                    break;
            }
        }

        async function loadDashboard() {
            try {
                // åŠ è½½ç»Ÿè®¡æ•°æ®
                const [salesResponse, ordersResponse, customersResponse] = await Promise.all([
                    fetch('/api/reports/sales'),
                    fetch('/api/orders'),
                    fetch('/api/reports/customers')
                ]);

                const salesData = await salesResponse.json();
                const ordersData = await ordersResponse.json();
                const customersData = await customersResponse.json();

                updateDashboardStats(salesData.data, ordersData.data, customersData.data);
            } catch (error) {
                console.error('åŠ è½½ä»ªè¡¨ç›˜å¤±è´¥:', error);
                showAlert('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥', 'error');
            }
        }

        function updateDashboardStats(salesData, ordersData, customersData) {
            // è®¡ç®—ä»Šæ—¥æ•°æ®
            const today = new Date().toISOString().split('T')[0];
            const todayData = salesData.find(item => item.date === today) || { total_sales: 0, order_count: 0, avg_order_value: 0 };

            document.getElementById('todaySales').textContent = `Â¥${todayData.total_sales.toFixed(2)}`;
            document.getElementById('todayOrders').textContent = todayData.order_count;
            document.getElementById('avgOrderValue').textContent = `Â¥${todayData.avg_order_value.toFixed(2)}`;
            document.getElementById('totalCustomers').textContent = customersData.length;
        }

        async function loadSalesReport() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                const response = await fetch(`/api/reports/sales?start_date=${startDate}&end_date=${endDate}`);
                const result = await response.json();

                if (result.success) {
                    renderSalesReport(result.data);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('åŠ è½½é”€å”®æŠ¥å‘Šå¤±è´¥:', error);
                showAlert('åŠ è½½é”€å”®æŠ¥å‘Šå¤±è´¥', 'error');
            }
        }

        function renderSalesReport(data) {
            const container = document.getElementById('salesReportContainer');
            
            if (data.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096;">é€‰å®šæ—¶é—´èŒƒå›´å†…æ— é”€å”®æ•°æ®</p>';
                return;
            }

            let totalSales = 0;
            let totalOrders = 0;

            const table = document.createElement('table');
            table.className = 'table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>è®¢å•æ•°é‡</th>
                        <th>é”€å”®æ€»é¢</th>
                        <th>å¹³å‡è®¢å•ä»·å€¼</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map(item => {
                        totalSales += item.total_sales;
                        totalOrders += item.order_count;
                        return `
                            <tr>
                                <td>${item.date}</td>
                                <td>${item.order_count}</td>
                                <td>Â¥${item.total_sales.toFixed(2)}</td>
                                <td>Â¥${item.avg_order_value.toFixed(2)}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
                <tfoot>
                    <tr style="background: #f7fafc; font-weight: bold;">
                        <td>æ€»è®¡</td>
                        <td>${totalOrders}</td>
                        <td>Â¥${totalSales.toFixed(2)}</td>
                        <td>Â¥${totalOrders > 0 ? (totalSales / totalOrders).toFixed(2) : '0.00'}</td>
                    </tr>
                </tfoot>
            `;

            container.innerHTML = '';
            container.appendChild(table);
        }

        async function loadProductReport() {
            try {
                const response = await fetch('/api/reports/products');
                const result = await response.json();

                if (result.success) {
                    renderProductReport(result.data);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('åŠ è½½äº§å“æŠ¥å‘Šå¤±è´¥:', error);
                showAlert('åŠ è½½äº§å“æŠ¥å‘Šå¤±è´¥', 'error');
            }
        }

        function renderProductReport(data) {
            const container = document.getElementById('productReportContainer');
            
            if (data.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096;">æš‚æ— äº§å“é”€å”®æ•°æ®</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>äº§å“åç§°</th>
                        <th>åˆ†ç±»</th>
                        <th>é”€å”®æ•°é‡</th>
                        <th>é”€å”®æ”¶å…¥</th>
                        <th>è®¢å•æ¬¡æ•°</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map((item, index) => `
                        <tr>
                            <td>
                                <span style="color: #667eea; font-weight: bold;">#${index + 1}</span>
                                ${item.product_name}
                            </td>
                            <td>${item.category}</td>
                            <td>${item.total_quantity}</td>
                            <td>Â¥${item.total_revenue.toFixed(2)}</td>
                            <td>${item.order_count}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            container.innerHTML = '';
            container.appendChild(table);
        }

        async function loadCustomerReport() {
            try {
                const response = await fetch('/api/reports/customers');
                const result = await response.json();

                if (result.success) {
                    renderCustomerReport(result.data);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('åŠ è½½å®¢æˆ·æŠ¥å‘Šå¤±è´¥:', error);
                showAlert('åŠ è½½å®¢æˆ·æŠ¥å‘Šå¤±è´¥', 'error');
            }
        }

        function renderCustomerReport(data) {
            const container = document.getElementById('customerReportContainer');
            
            if (data.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096;">æš‚æ— å®¢æˆ·æ•°æ®</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>å®¢æˆ·å§“å</th>
                        <th>å®¢æˆ·ç±»å‹</th>
                        <th>è®¢å•æ•°é‡</th>
                        <th>æ¶ˆè´¹æ€»é¢</th>
                        <th>å¹³å‡è®¢å•ä»·å€¼</th>
                        <th>æœ€åä¸‹å•æ—¥æœŸ</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map((item, index) => `
                        <tr>
                            <td>
                                <span style="color: #667eea; font-weight: bold;">#${index + 1}</span>
                                ${item.customer_name}
                            </td>
                            <td>
                                <span class="badge ${item.customer_type === 'member' ? 'badge-gold' : 'badge-silver'}">
                                    ${item.customer_type === 'member' ? 'ä¼šå‘˜' : 'æ™®é€š'}
                                </span>
                            </td>
                            <td>${item.order_count}</td>
                            <td>Â¥${item.total_spent.toFixed(2)}</td>
                            <td>Â¥${item.avg_order_value.toFixed(2)}</td>
                            <td>${item.last_order_date ? new Date(item.last_order_date).toLocaleDateString('zh-CN') : 'æ— '}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            container.innerHTML = '';
            container.appendChild(table);
        }

        async function loadAllOrders() {
            try {
                const response = await fetch('/api/orders');
                const result = await response.json();

                if (result.success) {
                    renderAllOrders(result.data);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
                showAlert('åŠ è½½è®¢å•å¤±è´¥', 'error');
            }
        }

        function renderAllOrders(orders) {
            const container = document.getElementById('allOrdersContainer');
            
            if (orders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096;">æš‚æ— è®¢å•æ•°æ®</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>è®¢å•å·</th>
                        <th>å®¢æˆ·å§“å</th>
                        <th>è®¢å•æ—¥æœŸ</th>
                        <th>çŠ¶æ€</th>
                        <th>æ”¯ä»˜æ–¹å¼</th>
                        <th>æ€»é‡‘é¢</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    ${orders.map(order => `
                        <tr>
                            <td>#${order.order_id}</td>
                            <td>${order.customer_name}</td>
                            <td>${new Date(order.order_date).toLocaleString('zh-CN')}</td>
                            <td><span class="status-${order.status}">${getStatusText(order.status)}</span></td>
                            <td>${getPaymentMethodText(order.payment_method)}</td>
                            <td>Â¥${order.total_amount.toFixed(2)}</td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8em;" 
                                        onclick="viewOrderDetails(${order.order_id})">
                                    æŸ¥çœ‹è¯¦æƒ…
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            container.innerHTML = '';
            container.appendChild(table);
        }

        function exportSalesReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // è¿™é‡Œå¯ä»¥å®ç°å¯¼å‡ºåŠŸèƒ½ï¼Œæ¯”å¦‚ç”ŸæˆCSVæ–‡ä»¶
            showAlert('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }
    </script>

    <style>
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .badge-gold {
            background: linear-gradient(45deg, #f6ad55, #ed8936);
            color: white;
        }
        
        .badge-silver {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .status-pending { color: #ed8936; }
        .status-processing { color: #3182ce; }
        .status-completed { color: #38a169; }
        .status-cancelled { color: #e53e3e; }
    </style>
</body>
</html>